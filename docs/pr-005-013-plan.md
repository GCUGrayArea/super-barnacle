# PR-005 and PR-013 Detailed Planning

**Generated:** 2025-11-15
**Status:** Both PRs Ready to Start in Parallel
**Purpose:** Detailed planning for PR-005 (SkyFi API Client) and PR-013 (MCP Server Setup)

---

## âœ… Parallelization Analysis

**CONCLUSION: PR-005 and PR-013 can run in PARALLEL with ZERO file conflicts! ðŸŽ‰**

### File Conflict Matrix

| File/Directory | PR-005 | PR-013 |
|---|---|---|
| src/skyfi/ | âœ… CREATE | - |
| src/mcp/ | - | âœ… CREATE |
| src/lib/ | âœ… CREATE (retry.ts, rate-limiter.ts) | - |
| src/types/ | âœ… CREATE (skyfi-base.ts) | - |
| src/index.ts | - | âœ… MODIFY |
| __tests__/skyfi/ | âœ… CREATE | - |
| __tests__/mcp/ | - | âœ… CREATE |
| __tests__/lib/ | âœ… CREATE (retry.test.ts) | - |

**Analysis:**
- âœ… **Zero file conflicts** - completely different directories
- âœ… **Zero logic conflicts** - independent functionality
- âœ… Both depend only on PR-001 and PR-004 (both complete)
- âœ… Can be developed, tested, and committed independently

---

## ðŸ“‹ PR-005: SkyFi API Client Base

### Overview
**Status:** READY TO START - UNBLOCKED âœ…
**Dependencies:** PR-001 âœ…, PR-004 âœ… (both complete)
**Priority:** High
**Estimated Time:** 60-90 minutes
**Blocks:** PR-007, PR-008, PR-009, PR-010, PR-011, PR-012 (all of Block 3)

### Description
Create the foundational HTTP client for SkyFi API with authentication, request/response handling, rate limiting, and retry logic. This is critical infrastructure that all SkyFi API interactions will use.

### Files to Create

#### Core Implementation (4 files)
```
src/skyfi/
â”œâ”€â”€ client.ts       - Base HTTP client with Axios
â”‚                     â€¢ SkyFiClient class
â”‚                     â€¢ Authentication header injection (X-Skyfi-Api-Key)
â”‚                     â€¢ Request/response interceptors
â”‚                     â€¢ Integration with retry and rate limiting
â”‚                     â€¢ Comprehensive error handling
â”‚
â””â”€â”€ config.ts       - SkyFi API configuration
                      â€¢ Base URL: https://app.skyfi.com/platform-api
                      â€¢ API key loading from SKYFI_API_KEY env var
                      â€¢ Request timeout configuration
                      â€¢ Rate limit settings
```

#### Support Libraries (2 files)
```
src/lib/
â”œâ”€â”€ retry.ts        - Retry logic with exponential backoff
â”‚                     â€¢ RetryConfig interface
â”‚                     â€¢ withRetry() higher-order function
â”‚                     â€¢ Exponential backoff calculation (2^attempt * baseDelay)
â”‚                     â€¢ Max 3 retries by default
â”‚                     â€¢ Retry on 5xx errors and network failures
â”‚                     â€¢ Don't retry on 4xx errors (client errors)
â”‚
â””â”€â”€ rate-limiter.ts - Rate limiting logic
                      â€¢ RateLimiter class with token bucket algorithm
                      â€¢ Configurable requests per second
                      â€¢ Queue management for pending requests
                      â€¢ Integration with SkyFi API limits
```

#### Type Definitions (1 file)
```
src/types/
â””â”€â”€ skyfi-base.ts   - Base type definitions
                      â€¢ SkyFiClientConfig interface
                      â€¢ RetryConfig interface
                      â€¢ RateLimitConfig interface
                      â€¢ RequestContext interface
                      â€¢ ApiResponse<T> generic type
```

#### Tests (2 files)
```
__tests__/skyfi/
â””â”€â”€ client.test.ts  - Client unit tests (60+ tests expected)
                      â€¢ Client initialization tests
                      â€¢ Authentication header tests
                      â€¢ Request/response interceptor tests
                      â€¢ Error handling tests
                      â€¢ Integration with retry logic tests
                      â€¢ Integration with rate limiting tests
                      â€¢ Mock Axios with jest.mock()

__tests__/lib/
â””â”€â”€ retry.test.ts   - Retry logic tests (30+ tests expected)
                      â€¢ Exponential backoff calculation tests
                      â€¢ Successful retry tests
                      â€¢ Max retry limit tests
                      â€¢ Non-retryable error tests (4xx)
                      â€¢ Retryable error tests (5xx, network)
```

### Acceptance Criteria

#### Core Functionality
- [ ] Axios client configured with base URL: https://app.skyfi.com/platform-api
- [ ] API key loaded from environment variable (SKYFI_API_KEY)
- [ ] Authentication header (X-Skyfi-Api-Key) automatically added to all requests
- [ ] Request timeout configured (default 30 seconds)

#### Retry Logic
- [ ] Retry logic with exponential backoff implemented
- [ ] Max 3 retries by default (configurable)
- [ ] Exponential backoff: 2^attempt * baseDelay (base = 1000ms)
- [ ] Retries on 5xx errors and network failures
- [ ] Does NOT retry on 4xx errors (client errors)

#### Rate Limiting
- [ ] Rate limiting implemented to respect SkyFi API limits
- [ ] Token bucket algorithm or similar
- [ ] Configurable requests per second
- [ ] Queue management for pending requests

#### Logging and Error Handling
- [ ] Request/response interceptors for logging
- [ ] Never log API keys or sensitive credentials
- [ ] Uses logger from PR-004 (src/lib/logger.ts)
- [ ] Uses custom errors from PR-004 (src/lib/errors.ts)
- [ ] Comprehensive error handling with SkyFiAPIError

#### Testing
- [ ] Tests cover authentication scenarios
- [ ] Tests cover retry scenarios (success after failure, max retries)
- [ ] Tests cover rate limiting scenarios
- [ ] Tests cover error scenarios (4xx, 5xx, network)
- [ ] Test coverage >80%
- [ ] All tests passing
- [ ] Axios properly mocked in tests

#### Code Quality
- [ ] TypeScript compiles with no errors
- [ ] ESLint passes with no errors
- [ ] 100% type coverage (no `any` types without justification)
- [ ] Follows coding standards from .claude/rules/coding-standards.md

### Implementation Notes

#### Key Dependencies
```typescript
import axios, { AxiosInstance, AxiosRequestConfig } from 'axios';
import { logger } from './lib/logger';
import { SkyFiAPIError } from './lib/errors';
import { withRetry } from './lib/retry';
import { RateLimiter } from './lib/rate-limiter';
```

#### Environment Variables
```bash
SKYFI_API_KEY=<your-api-key>  # Required
SKYFI_API_BASE_URL=https://app.skyfi.com/platform-api  # Optional, has default
SKYFI_REQUEST_TIMEOUT=30000  # Optional, milliseconds
```

#### SkyFiClient Usage Pattern
```typescript
import { SkyFiClient } from './skyfi/client';

const client = new SkyFiClient({
  apiKey: process.env.SKYFI_API_KEY,
  baseURL: 'https://app.skyfi.com/platform-api',
  timeout: 30000,
  retry: {
    maxRetries: 3,
    baseDelay: 1000,
  },
  rateLimit: {
    requestsPerSecond: 10,
  },
});

// Make requests
const response = await client.get('/archives', { params: { ... } });
const data = await client.post('/order-archive', body);
```

#### Critical Implementation Details
1. **Never log API keys:** Use logger's built-in sanitization from PR-004
2. **Retry strategy:** Only retry on transient errors (5xx, network), not client errors (4xx)
3. **Rate limiting:** Implement queue to avoid hitting API limits
4. **Error handling:** Convert Axios errors to SkyFiAPIError with proper context
5. **Type safety:** Use generics for request/response types: `client.get<ResponseType>(url)`

### Testing Strategy

#### Unit Tests for client.ts
```typescript
describe('SkyFiClient', () => {
  describe('initialization', () => {
    it('should create client with API key from config');
    it('should throw ConfigurationError if API key missing');
    it('should set base URL from config');
    it('should set default timeout');
  });

  describe('authentication', () => {
    it('should add X-Skyfi-Api-Key header to all requests');
    it('should not log API key in request logs');
  });

  describe('request methods', () => {
    it('should make GET requests');
    it('should make POST requests');
    it('should make PUT requests');
    it('should make DELETE requests');
  });

  describe('error handling', () => {
    it('should convert 4xx errors to SkyFiAPIError');
    it('should convert 5xx errors to SkyFiAPIError');
    it('should handle network errors');
    it('should include response data in error context');
  });

  describe('retry integration', () => {
    it('should retry on 5xx errors');
    it('should not retry on 4xx errors');
    it('should respect max retry limit');
  });

  describe('rate limiting integration', () => {
    it('should queue requests when rate limit reached');
    it('should process queued requests');
  });
});
```

#### Unit Tests for retry.ts
```typescript
describe('withRetry', () => {
  it('should succeed on first attempt if no error');
  it('should retry on transient errors');
  it('should use exponential backoff');
  it('should respect max retries');
  it('should not retry on non-retryable errors');
  it('should pass through successful result');
});
```

---

## ðŸ“‹ PR-013: MCP Server Setup and HTTP/SSE Transport

### Overview
**Status:** READY TO START - UNBLOCKED âœ…
**Dependencies:** PR-001 âœ…, PR-004 âœ… (both complete)
**Priority:** High
**Estimated Time:** 60-90 minutes
**Blocks:** PR-014, PR-015, PR-016, PR-017, PR-018, PR-019 (all of Block 5 - MCP Tools)

### Description
Set up the MCP (Model Context Protocol) server using @modelcontextprotocol/sdk with HTTP and Server-Sent Events (SSE) transport for stateless operation. This is the foundation for all MCP tools that will expose SkyFi functionality to AI agents.

### Files to Create

#### Core Implementation (3 files)
```
src/mcp/
â”œâ”€â”€ server.ts       - MCP server initialization
â”‚                     â€¢ MCPServer class
â”‚                     â€¢ Tool registration system
â”‚                     â€¢ Request handler
â”‚                     â€¢ Graceful shutdown
â”‚                     â€¢ Health check endpoint
â”‚
â”œâ”€â”€ transport.ts    - HTTP/SSE transport implementation
â”‚                     â€¢ HTTP endpoint for request/response
â”‚                     â€¢ SSE endpoint for streaming updates
â”‚                     â€¢ Stateless design (no session storage)
â”‚                     â€¢ Request correlation
â”‚
â””â”€â”€ config.ts       - MCP server configuration
                      â€¢ Port configuration (default 3000)
                      â€¢ CORS settings
                      â€¢ Timeouts
                      â€¢ Environment-based config
```

#### Modified File (1 file)
```
src/index.ts        - Entry point to start MCP server
                      â€¢ MODIFY to import and initialize MCP server
                      â€¢ Replace TODO placeholders
                      â€¢ Integrate with logger from PR-004
                      â€¢ Keep existing graceful shutdown handlers
```

#### Tests (2 files)
```
__tests__/mcp/
â”œâ”€â”€ server.test.ts     - Server unit tests (40+ tests expected)
â”‚                        â€¢ Server initialization tests
â”‚                        â€¢ Tool registration tests
â”‚                        â€¢ Request handling tests
â”‚                        â€¢ Health check tests
â”‚                        â€¢ Graceful shutdown tests
â”‚
â””â”€â”€ transport.test.ts  - Transport unit tests (30+ tests expected)
                         â€¢ HTTP transport tests
                         â€¢ SSE transport tests
                         â€¢ Stateless operation tests
                         â€¢ Error handling tests
```

### Acceptance Criteria

#### MCP Server Core
- [ ] MCP server initializes successfully using @modelcontextprotocol/sdk
- [ ] Tool registration system in place (ready for Block 5 PRs)
- [ ] Request handler processes MCP protocol messages
- [ ] Stateless design (no session storage on server)
- [ ] Graceful shutdown handling (cleanup, pending requests)

#### HTTP/SSE Transport
- [ ] HTTP transport working for request/response
- [ ] SSE (Server-Sent Events) transport working for streaming updates
- [ ] Proper Content-Type headers for SSE (text/event-stream)
- [ ] Connection keep-alive for SSE
- [ ] CORS enabled for cross-origin requests

#### Health & Monitoring
- [ ] Health check endpoint (/health) returns 200 OK when healthy
- [ ] Health check validates MCP server is initialized
- [ ] Structured logging for all requests using PR-004 logger
- [ ] Request correlation IDs for tracing
- [ ] Error logging with proper error handling

#### Configuration
- [ ] Environment configuration (PORT, NODE_ENV, etc.)
- [ ] Port configurable via PORT env var (default 3000)
- [ ] Timeout configuration
- [ ] CORS configuration (allow all origins for dev, configurable for prod)

#### Testing
- [ ] Unit tests >80% coverage
- [ ] All tests passing
- [ ] Mock @modelcontextprotocol/sdk if needed
- [ ] Integration tests for HTTP/SSE transport

#### Code Quality
- [ ] TypeScript compiles with no errors
- [ ] ESLint passes with no errors
- [ ] 100% type coverage (no `any` types without justification)
- [ ] Follows coding standards from .claude/rules/coding-standards.md

### Implementation Notes

#### Key Dependencies
```typescript
import { Server } from '@modelcontextprotocol/sdk/server/index.js';
import { SSEServerTransport } from '@modelcontextprotocol/sdk/server/sse.js';
import { StdioServerTransport } from '@modelcontextprotocol/sdk/server/stdio.js';
import express from 'express';  // May need to add to package.json
import { logger } from '../lib/logger';
import { handleError } from '../lib/error-handler';
```

#### Environment Variables
```bash
PORT=3000  # Optional, default 3000
NODE_ENV=development  # development | production
MCP_LOG_LEVEL=INFO  # DEBUG | INFO | WARN | ERROR
```

#### MCP Server Usage Pattern
```typescript
import { MCPServer } from './mcp/server';

const server = new MCPServer({
  name: 'skyfi-mcp',
  version: '1.0.0',
  port: 3000,
});

// Register tools (will be done in Block 5 PRs)
server.registerTool('search_archives', archiveSearchTool);
server.registerTool('order_archive', orderArchiveTool);

// Start server
await server.start();
```

#### MCP Protocol Overview
The Model Context Protocol defines:
- **Tools:** Functions that AI agents can call
- **Prompts:** Pre-defined prompts for specific tasks
- **Resources:** Access to data sources
- **Sampling:** Text generation capabilities

For PR-013, we focus on:
1. Server setup
2. HTTP/SSE transport
3. Tool registration framework (tools implemented in Block 5)

#### Critical Implementation Details
1. **Stateless design:** No session storage, each request is independent
2. **SSE for streaming:** Use Server-Sent Events for real-time updates
3. **Health checks:** Simple /health endpoint for load balancer monitoring
4. **Logging:** Use logger from PR-004 with correlation IDs
5. **Graceful shutdown:** Clean up resources, finish pending requests

### Modified File Details

#### src/index.ts Changes
```typescript
// BEFORE (current state):
function main(): void {
  console.log('SkyFi MCP Server - Starting...');
  // TODO(PR-013): Initialize MCP server with HTTP/SSE transport
  // TODO(PR-013): Register all MCP tools
  // TODO(PR-013): Start listening on configured port
  console.log('SkyFi MCP Server - Ready (placeholder mode)');
}

// AFTER (PR-013 implementation):
import { MCPServer } from './mcp/server';
import { logger } from './lib/logger';

async function main(): Promise<void> {
  logger.info('SkyFi MCP Server - Starting...');

  const server = new MCPServer({
    name: 'skyfi-mcp',
    version: '1.0.0',
    port: parseInt(process.env.PORT ?? '3000', 10),
  });

  // Tool registration will be added in Block 5 PRs
  // server.registerTool('search_archives', ...);

  await server.start();

  logger.info('SkyFi MCP Server - Ready', {
    port: server.port,
    environment: process.env.NODE_ENV ?? 'development',
  });

  return server;
}
```

### Testing Strategy

#### Unit Tests for server.ts
```typescript
describe('MCPServer', () => {
  describe('initialization', () => {
    it('should create server with config');
    it('should set default port to 3000');
    it('should use PORT env var if provided');
  });

  describe('tool registration', () => {
    it('should register a tool');
    it('should throw error for duplicate tool names');
    it('should list registered tools');
  });

  describe('request handling', () => {
    it('should handle valid MCP requests');
    it('should return error for invalid requests');
    it('should include correlation ID in responses');
  });

  describe('health check', () => {
    it('should return 200 OK when healthy');
    it('should include server status in response');
  });

  describe('lifecycle', () => {
    it('should start server');
    it('should stop server gracefully');
    it('should handle shutdown signal');
  });
});
```

#### Unit Tests for transport.ts
```typescript
describe('HTTP/SSE Transport', () => {
  describe('HTTP transport', () => {
    it('should handle POST requests');
    it('should parse JSON body');
    it('should return JSON responses');
    it('should handle errors');
  });

  describe('SSE transport', () => {
    it('should establish SSE connection');
    it('should send events via SSE');
    it('should set correct Content-Type header');
    it('should handle connection close');
  });

  describe('CORS', () => {
    it('should allow cross-origin requests');
    it('should set CORS headers');
  });
});
```

---

## ðŸš€ Recommended Execution Strategy

### Option 1: Sequential (Conservative)
```
1. Agent A â†’ PR-005 (60-90 min)
2. Wait for PR-005 completion
3. Agent A or B â†’ PR-013 (60-90 min)
Total time: 120-180 minutes sequential
```

### Option 2: Parallel (Optimal) â­
```
1. Agent A â†’ PR-005 (60-90 min)  } Run in parallel
2. Agent B â†’ PR-013 (60-90 min)  }
Total time: 60-90 minutes parallel
```

**Recommendation: Option 2 (Parallel)** âœ…
- Zero file conflicts confirmed
- Independent functionality
- Both well-defined with clear acceptance criteria
- Doubles development velocity

---

## ðŸ“Š Impact Analysis

### After PR-005 Completes
**Unblocks:** 6 PRs in Block 3 (can all run in parallel!)
- PR-007: Archive Search Implementation
- PR-008: Order Placement Implementation
- PR-009: Feasibility and Pass Prediction Implementation
- PR-010: Order Management Implementation
- PR-011: Notifications/Monitoring Implementation
- PR-012: Pricing API Implementation

### After PR-013 Completes
**Unblocks:** 6 PRs in Block 5 (MCP Tools)
- PR-014: Archive Search MCP Tool
- PR-015: Order Placement MCP Tools
- PR-016: Feasibility Checking MCP Tools
- PR-017: Order Management MCP Tools
- PR-018: Monitoring MCP Tools
- PR-019: Pricing MCP Tool

### Combined Impact
After both PR-005 AND PR-013 complete:
- Block 3 PRs (007-012) can start - these depend on PR-005 + PR-006
- Block 5 PRs (014-019) need Block 3 + Block 4, so will wait

**Critical Path:**
```
PR-005 âœ… â†’ Block 3 (6 PRs in parallel) â†’ Block 5 (6 PRs in parallel)
PR-013 âœ… â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âœ… Pre-Flight Checklist

### Before Starting PR-005
- [x] PR-001 is Complete
- [x] PR-004 is Complete
- [x] PR-006 is Complete (provides types to reference)
- [x] No other agent working on conflicting files
- [x] All 167 tests passing
- [x] TypeScript builds successfully

### Before Starting PR-013
- [x] PR-001 is Complete
- [x] PR-004 is Complete
- [x] No other agent working on conflicting files
- [x] All 167 tests passing
- [x] TypeScript builds successfully
- [x] @modelcontextprotocol/sdk is installed (verify in package.json)

---

## ðŸ“ Git Workflow

**Branch:** `claude/review-task-list-state-01DZuwKLGGSbucKZKqzUHCEm`

**Commit Messages:**
```bash
# PR-005
feat(client): implement SkyFi API client with retry and rate limiting

- Add base HTTP client with Axios and authentication
- Implement exponential backoff retry logic (max 3 retries)
- Add rate limiter with token bucket algorithm
- Comprehensive error handling with SkyFiAPIError
- 90+ tests with >80% coverage

# PR-013
feat(mcp): implement MCP server with HTTP/SSE transport

- Initialize MCP server using @modelcontextprotocol/sdk
- Implement HTTP and SSE transport for stateless operation
- Add health check endpoint
- Integrate with logging infrastructure
- 70+ tests with >80% coverage
```

**Push Strategy:**
- Commit locally during development
- Push when PR is complete and all tests pass
- `git push -u origin claude/review-task-list-state-01DZuwKLGGSbucKZKqzUHCEm`

---

**Last Updated:** 2025-11-15
**Ready for Implementation:** âœ… YES
